#!/bin/sh

mkdir -p ~/.config/shaur && cd ~/.config/shaur || exit

case $1 in
	-y | --dbupdate)
		echo "[AUR database update]"
		curl --url 'https://aur.archlinux.org/packages.gz' --create-dirs --output "packages.gz" >/dev/null && gunzip -f "packages.gz"
	;;
	-u | --upgrade)
		for i in ~/.config/shaur/*
		do
			[ -d "$i" ] || break
			cd "$i" || exit
			echo "$i: " | awk -F '/' '{print $NF}' | tr -d "\n"
			git pull
		done
	;;
	-S | --sync)
		! [ -f packages ] && echo "DB not found, type: $0 -y" && exit
		name=$(sort packages | sk --bind change:top --layout=reverse --preview "curl -s \"https://aur.archlinux.org/rpc/?v=5&type=search&by=name&arg=\"{}\"\" | grep {} | jq '.results[]' > tmp && jq 'select(.Name==\"{}\")' < tmp")

		if [ "$name" ]; then
			git clone https://aur.archlinux.org/"$name".git || exit
			cd "$name" || exit
			makepkg -si
		fi
	;;
	-h | --help)
		echo "Usage:
	$0 <operation> (you can use only one option) 

Operations:
	-h --help
	-u --upgrade 		
	-S --sync
	-y --dbupdate
	"
	;;		
	*)
		echo "shaur -> invalid option $@"
		echo "Try shaur -h or --help for more information"
	;;
esac
